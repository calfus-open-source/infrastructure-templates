resource "azurerm_application_security_group" "bastion_asg" {
  name                = "${var.project_name}-${var.environment}-bastion-asg"
  location            = var.location
  resource_group_name = var.resource_group_name
}

resource "azurerm_application_security_group" "vm_k8s_asg" {
  name                = "${var.project_name}-${var.environment}-k8s-asg"
  location            = var.location
  resource_group_name = var.resource_group_name
}

resource "azurerm_application_security_group" "app_gateway_asg" {
  name                = "${var.project_name}-${var.environment}-app-gateway-asg"
  location            = var.location
  resource_group_name = var.resource_group_name
}

resource "azurerm_application_security_group" "frontend_private_asg" {
  name                = "${var.project_name}-${var.environment}-frontend-private-asg"
  location            = var.location
  resource_group_name = var.resource_group_name
}

resource "azurerm_network_security_group" "k8s_vm_sg" {
  name                = "${var.project_name}-${var.environment}-k8s-vm-nsg"
  location            = var.location
  resource_group_name = var.resource_group_name
  tags                = merge({ Name = "K8s VM NSG" }, var.tags)

  security_rule {
    name                                       = "AllowAllFromAppGateway"
    priority                                   = 100
    direction                                  = "Inbound"
    access                                     = "Allow"
    protocol                                   = "*"
    source_port_range                          = "*"
    destination_port_range                     = "*"
    source_application_security_group_ids      = [azurerm_application_security_group.app_gateway_asg.id]
    destination_application_security_group_ids = [azurerm_application_security_group.vm_k8s_asg.id]
  }

  security_rule {
    name                       = "AllowAppGatewaySubnetToK8s"
    priority                   = 101
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "*"
    source_port_range          = "*"
    destination_port_range     = "*"
    source_address_prefix      = cidrsubnet(element(var.vnet_address_space, 0), var.subnet_prefix_length, var.app_gateway_subnet_offset)
    destination_address_prefix = cidrsubnet(element(var.vnet_address_space, 0), var.subnet_prefix_length, var.k8s_private_subnet_offset)
  }

  security_rule {
    name                                       = "AllowSSHFromBastion"
    priority                                   = 102
    direction                                  = "Inbound"
    access                                     = "Allow"
    protocol                                   = "Tcp"
    source_port_range                          = "*"
    destination_port_range                     = "22"
    source_application_security_group_ids      = [azurerm_application_security_group.bastion_asg.id]
    destination_application_security_group_ids = [azurerm_application_security_group.vm_k8s_asg.id]
  }

  security_rule {
    name                       = "AllowVPNToK8s"
    priority                   = 103
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "*"
    source_port_range          = "*"
    destination_port_range     = "*"
    source_address_prefix      = var.vpn_client_address_space[0]
    destination_address_prefix = cidrsubnet(element(var.vnet_address_space, 0), var.subnet_prefix_length, var.k8s_private_subnet_offset)
  }
}

resource "azurerm_network_security_group" "bastion_nsg" {
  name                = "${var.project_name}-${var.environment}-bastion-nsg"
  location            = var.location
  resource_group_name = var.resource_group_name
  tags                = merge({ Name = "Bastion NSG" }, var.tags)

  security_rule {
    name                                       = "AllowSSHFromSpecificIPs"
    priority                                   = 100
    direction                                  = "Inbound"
    access                                     = "Allow"
    protocol                                   = "Tcp"
    source_port_range                          = "*"
    destination_port_range                     = "22"
    source_address_prefixes                    = var.source_bastion_ip
    destination_application_security_group_ids = [azurerm_application_security_group.bastion_asg.id]
  }
}

resource "azurerm_network_security_group" "app_gateway_nsg" {
  name                = "${var.project_name}-${var.environment}-app-gateway-nsg"
  location            = var.location
  resource_group_name = var.resource_group_name
  tags                = var.tags

  security_rule {
    name                       = "allow-http-vpn"
    priority                   = 100
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_ranges    = ["80"]
    source_address_prefix      = var.vpn_client_address_space[0]
    destination_address_prefix = "*"
  }

  security_rule {
    name                       = "allow-https-vpn"
    priority                   = 101
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_ranges    = ["443"]
    source_address_prefix      = var.vpn_client_address_space[0]
    destination_address_prefix = "*"
  }

  security_rule {
    name                       = "allow-appgw-ports"
    priority                   = 102
    direction                  = "Inbound"
    access                     = "Allow"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_ranges    = ["65200-65535"]
    source_address_prefix      = "GatewayManager"
    destination_address_prefix = "*"
  }

  security_rule {
    name                       = "deny-internet-http"
    priority                   = 200
    direction                  = "Inbound"
    access                     = "Deny"
    protocol                   = "Tcp"
    source_port_range          = "*"
    destination_port_ranges    = ["80", "443"]
    source_address_prefix      = "Internet"
    destination_address_prefix = "*"
  }
}

resource "azurerm_network_security_group" "frontend_private_nsg" {
  name
